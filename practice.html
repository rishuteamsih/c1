<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Practice Mode – Published Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            background: #f9f9f9;
            color: #111;
            padding: 20px;
        }

        header {
            background: #673ab7;
            color: white;
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
        }

        .card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input {
            display: block;
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
        }

        .btn {
            cursor: pointer;
            border-radius: 6px;
            padding: 8px 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            margin: 4px;
        }

        .btn.primary {
            background: #512da8;
            color: white;
        }

        .btn.secondary {
            background: #9575cd;
            color: white;
        }

        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            background: #fff;
            transition: all .3s ease;
        }

        .test-card:hover {
            background: #ede7f6;
            transform: translateY(-2px);
        }

        .question {
            margin-top: 12px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f0f0f0;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-bar input,
        .filter-bar select {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #bbb;
        }

        .test-details {
            display: none;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            margin-top: 8px;
        }

        .show {
            display: block;
        }

        .correct {
            background: #c8e6c9;
        }

        .wrong {
            background: #ffcdd2;
        }

        .muted {
            color: #666;
            font-size: 13px;
        }

        .ok {
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <header>🧠 Practice Mode – Published Tests</header>

    <div class="card" id="authCard">
        <div id="authStatus" class="muted">Checking sign-in…</div>
    </div>

    <div class="card" id="setupCard" style="display:none;">
        <h2>Set Up Your Profile</h2>
        <input id="studentName" placeholder="Enter Your Name" />
        <input id="studentId" placeholder="Enter Your Roll Number / ID" />
        <button class="btn primary" onclick="saveProfile()">Continue</button>
    </div>

    <div class="card" id="testListCard" style="display:none;">
        <h2>Available Practice Tests</h2>
        <div class="filter-bar">
            <input id="searchBox" placeholder="🔍 Search test by title or code..." oninput="applyFilter()" />
            <select id="filterMode" onchange="applyFilter()">
                <option value="all">All</option>
                <option value="public">Public Only</option>
                <option value="private">Private Only</option>
            </select>
        </div>
        <div id="testList"></div>
    </div>

    <div class="card" id="practiceSection" style="display:none;">
        <h2 id="testTitle"></h2>
        <p id="testDescription"></p>
        <div id="questionArea"></div>
        <button class="btn primary" onclick="submitPractice()">Finish Practice</button>
        <div id="scoreArea"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAFKmM22FUSQPYy-eMsBzcZN3bmAxglXl0",
            authDomain: "smart-timetable-266fe.firebaseapp.com",
            projectId: "smart-timetable-266fe",
            storageBucket: "smart-timetable-266fe.appspot.com",
            messagingSenderId: "843230713835",
            appId: "1:843230713835:web:b97d024f4fcf9a40ceabae",
            measurementId: "G-DDY9NVEK8R"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentProfile = null;
        let currentTest = null;

        const authStatus = document.getElementById("authStatus");

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authStatus.innerHTML = `✅ Signed in as <strong>${user.email || 'User'}</strong>`;
                const docRef = db.collection("users").doc(user.uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    currentProfile = docSnap.data();
                }

                if (!currentProfile || !currentProfile.name || !currentProfile.rollNo) {
                    document.getElementById("setupCard").style.display = "block";
                } else {
                    document.getElementById("setupCard").style.display = "none";
                    document.getElementById("testListCard").style.display = "block";
                    loadPracticeTests();
                }
            } else {
                await auth.signInAnonymously();
            }
        });

        async function saveProfile() {
            const name = document.getElementById("studentName").value.trim();
            const roll = document.getElementById("studentId").value.trim();
            if (!name || !roll) return alert("Please fill in both fields");

            await db.collection("users").doc(currentUser.uid).set({
                name, rollNo: roll, role: "student"
            }, { merge: true });

            currentProfile = { name, rollNo: roll };
            document.getElementById("setupCard").style.display = "none";
            document.getElementById("testListCard").style.display = "block";
            loadPracticeTests();
        }

        async function loadPracticeTests() {
            const snap = await db.collection("tests").where("resultsPublished", "==", true).get();
            renderTests(snap);
        }

        function applyFilter() { loadPracticeTests(); }

        function renderTests(snap) {
            const container = document.getElementById("testList");
            container.innerHTML = "";
            const modeFilter = (document.getElementById("filterMode")?.value || "all").toLowerCase();
            const search = (document.getElementById("searchBox")?.value || "").toLowerCase();

            snap.docs.forEach(doc => {
                const t = doc.data();
                const id = doc.id;
                const acc = (t.accessMode || "private").toLowerCase();
                if (modeFilter !== "all" && acc !== modeFilter) return;
                const title = (t.title || "").toLowerCase();
                if (search && !title.includes(search) && !id.toLowerCase().includes(search)) return;

                const totalMarks = (t.questions || []).reduce((sum, q) => sum + (Number(q.marks) || 0), 0);
                const div = document.createElement("div");
                div.className = "test-card";
                div.innerHTML = `
          <h3>${t.title || "(Untitled Test)"}</h3>
          <p><strong>Access:</strong> ${acc}</p>
          <p><strong>Total Questions:</strong> ${t.questions?.length || 0}</p>
          <p><strong>Total Marks:</strong> ${totalMarks}</p>
          <button class="btn secondary" onclick="startPractice('${id}')">🧩 Practice Now</button>
        `;
                container.appendChild(div);
            });
        }

        async function startPractice(id) {
            const doc = await db.collection("tests").doc(id).get();
            const t = doc.data();
            currentTest = { id, ...t };

            document.getElementById("testListCard").style.display = "none";
            document.getElementById("practiceSection").style.display = "block";
            document.getElementById("testTitle").textContent = t.title;
            document.getElementById("testDescription").textContent = t.description || "";

            const qArea = document.getElementById("questionArea");
            qArea.innerHTML = "";

            (t.questions || []).forEach((q, i) => {
                const div = document.createElement("div");
                div.className = "question";
                div.innerHTML = `<strong>Q${i + 1} (${q.marks} marks):</strong> ${q.text}<br>`;
                if (q.type === "mcq" && q.options) {
                    q.options.forEach(opt => {
                        div.innerHTML += `<label><input type="radio" name="q${i}" value="${opt}"> ${opt}</label><br>`;
                    });
                } else {
                    div.innerHTML += `<input type="text" name="q${i}" placeholder="Your answer" />`;
                }
                qArea.appendChild(div);
            });
        }

        function submitPractice() {
            const qList = currentTest.questions || [];
            let score = 0;
            const qArea = document.getElementById("questionArea");
            const elements = qArea.querySelectorAll(".question");

            qList.forEach((q, i) => {
                const el = elements[i];
                let val = "";
                if (q.type === "mcq") {
                    const selected = document.querySelector(`input[name="q${i}"]:checked`);
                    val = selected ? selected.value.trim() : "";
                } else {
                    const input = document.querySelector(`input[name="q${i}"]`);
                    val = input ? input.value.trim() : "";
                }

                if (val.toLowerCase() === (q.answer || "").toLowerCase()) {
                    score += q.marks || 1;
                    el.classList.add("correct");
                } else {
                    el.classList.add("wrong");
                    el.innerHTML += `<br><em>Correct answer:</em> ${q.answer}`;
                }
            });

            const total = qList.reduce((s, q) => s + (q.marks || 1), 0);
            document.getElementById("scoreArea").innerHTML =
                `<h3>✅ Practice Complete!</h3><p>Your Score: ${score} / ${total}</p>
         <button class="btn secondary" onclick="restart()">🔙 Back to List</button>`;
        }

        function restart() {
            document.getElementById("practiceSection").style.display = "none";
            document.getElementById("testListCard").style.display = "block";
        }
    </script>
</body>

</html>